<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Seguro de Vales</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --dark: #1e293b; --bg: #f8fafc; }
        body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 450px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        
        /* LOGIN */
        #login-screen { text-align: center; padding: 40px 20px; }
        .lock-icon { font-size: 50px; margin-bottom: 20px; }

        /* FORMULARIO */
        .input-group { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; }
        input { padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        
        .btn { cursor: pointer; border: none; border-radius: 8px; padding: 14px; font-weight: 700; color: white; width: 100%; text-transform: uppercase; }
        .btn-add { background: var(--dark); margin-bottom: 10px; }
        .btn-generate { background: var(--primary); margin-top: 20px; }
        .btn-login { background: var(--primary); margin-top: 10px; }

        /* LISTA ADMIN */
        .admin-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #fff9db; padding: 15px; border-radius: 10px; margin-top: 10px; border: 2px solid #fab005;
        }
        .btn-borrar { background: #ff0000; color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.7rem; }

        /* CLIENTE / SOCIO */
        .vale-item { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .vale-item.locked { opacity: 0.4; filter: grayscale(1); }
        .btn-send-wa { background: #25d366; width: auto; padding: 10px 15px; font-size: 0.8rem; }
        #ticket-view { display: none; text-align: center; background: white; min-height: 100vh; padding: 40px 20px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app" class="container">
    
    <div id="login-screen" class="card hidden">
        <div class="lock-icon">üîê</div>
        <h2>Acceso Restringido</h2>
        <p style="color:#64748b; font-size:0.9rem;">Introduce la clave maestra para gestionar vales</p>
        <input type="password" id="admin-pass" placeholder="Contrase√±a">
        <button class="btn btn-login" onclick="checkPass()">Entrar</button>
    </div>

    <div id="admin-panel" class="hidden">
        <div class="card">
            <h2 style="margin-top:0">‚õΩ Generador de Vales</h2>
            <div class="input-group">
                <label>Gasolinera</label>
                <input type="text" id="st-name" placeholder="Nombre de la estaci√≥n">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group"><label>C√≥digo</label><input type="text" id="v-code" placeholder="C√≥d."></div>
                <div class="input-group"><label>Importe ‚Ç¨</label><input type="number" id="v-amount" placeholder="‚Ç¨"></div>
            </div>
            <button class="btn btn-add" onclick="agregarVale()">+ A√ëADIR A LA LISTA</button>

            <div id="lista-previa-contenedor" class="hidden">
                <p style="font-weight:bold; font-size:0.8rem; margin: 20px 0 10px 0;">VALES EN ESTE PAQUETE:</p>
                <div id="lista-vales-admin"></div>
                <button class="btn btn-generate" onclick="copiarEnlace()">COPIAR MENSAJE WHATSAPP</button>
            </div>
        </div>
    </div>

    <div id="client-panel" class="hidden">
        <div class="card">
            <h2 id="client-title">Mis Vales</h2>
            <div id="lista-vales-cliente"></div>
        </div>
    </div>
</div>

<div id="ticket-view">
    <p id="t-station" style="font-weight: bold; color: #64748b; text-transform: uppercase;"></p>
    <h1 id="t-amount" style="font-size: 4rem; margin: 10px 0;"></h1>
    <svg id="barcode"></svg>
    <div id="t-code" style="letter-spacing: 5px; font-weight: bold;"></div>
    <p style="margin-top:40px; color:#94a3b8; font-size:0.8rem;">Presente este c√≥digo en caja.</p>
</div>

<script>
    // --- CAMBIA TU CONTRASE√ëA AQU√ç ---
    const CLAVE_MAESTRA = "fran1981guerra"; 
    // ---------------------------------

    let vales = [];
    const params = new URLSearchParams(window.location.search);
    const d = params.get('d');
    const s = params.get('s');

    function enc(o) { return btoa(encodeURIComponent(JSON.stringify(o)).replace(/%([0-9A-F]{2})/g, (m, p) => String.fromCharCode('0x' + p))); }
    function dec(str) { return JSON.parse(decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''))); }

    window.onload = () => {
        if (s) { 
            mostrarTicket(); 
        } else if (d) {
            document.getElementById('client-panel').classList.remove('hidden');
            dibujarValesCliente();
        } else {
            // Si entra a la URL limpia, pedimos login
            document.getElementById('login-screen').classList.remove('hidden');
        }
    };

    function checkPass() {
        const pass = document.getElementById('admin-pass').value;
        if (pass === CLAVE_MAESTRA) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
        } else {
            alert("Contrase√±a incorrecta");
        }
    }

    function agregarVale() {
        const c = document.getElementById('v-code').value;
        const a = document.getElementById('v-amount').value;
        if(!c || !a) return;
        vales.push({ id: c, am: a });
        actualizarListaAdmin();
        document.getElementById('v-code').value = '';
        document.getElementById('v-amount').value = '';
    }

    function borrarVale(index) {
        vales.splice(index, 1);
        actualizarListaAdmin();
    }

    function actualizarListaAdmin() {
        const cont = document.getElementById('lista-previa-contenedor');
        const lista = document.getElementById('lista-vales-admin');
        if(vales.length === 0) { cont.classList.add('hidden'); return; }
        cont.classList.remove('hidden');
        lista.innerHTML = vales.map((v, i) => `
            <div class="admin-item">
                <div><b>${v.am}‚Ç¨</b><br><small>${v.id}</small></div>
                <button class="btn-borrar" onclick="borrarVale(${i})">BORRAR</button>
            </div>
        `).join('');
    }

    function copiarEnlace() {
        const st = document.getElementById('st-name').value || "Estaci√≥n";
        const url = window.location.origin + window.location.pathname + '?d=' + enc({ s: st, v: vales });
        const msg = `‚õΩ *VALES DISPONIBLES*\nEstaci√≥n: *${st}*\n\nAcceda aqu√≠ para repartirlos:\n${url}`;
        navigator.clipboard.writeText(msg).then(() => alert("¬°Enlace copiado!"));
    }

    function dibujarValesCliente() {
        const data = dec(d);
        document.getElementById('client-title').innerText = "üìç " + data.s;
        const key = 'l_' + btoa(data.s).substring(0,5);
        const lkd = JSON.parse(localStorage.getItem(key)) || [];
        document.getElementById('lista-vales-cliente').innerHTML = data.v.map(v => {
            const is = lkd.includes(v.id);
            return `<div class="vale-item ${is?'locked':''}">
                <div><b>${v.am}‚Ç¨</b><br><small>${v.id}</small></div>
                <button class="btn btn-send-wa" ${is?'disabled':''} onclick="enviarSocio('${v.id}','${v.am}','${data.s}','${key}')">${is?'ENVIADO':'ENVIAR'}</button>
            </div>`;
        }).join('');
    }

    function enviarSocio(id, am, st, key) {
        const url = window.location.origin + window.location.pathname + '?s=' + enc({ i: id, a: am, st: st });
        const msg = `‚õΩ *VALE COMBUSTIBLE*\nImporte: *${am}‚Ç¨*\n\nüëá *VER C√ìDIGO:* \n${url}\n\n‚ö†Ô∏è Si el link sale negro, resp√≥ndeme "OK".`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        let lkd = JSON.parse(localStorage.getItem(key)) || [];
        if(!lkd.includes(id)) { lkd.push(id); localStorage.setItem(key, JSON.stringify(lkd)); }
        setTimeout(dibujarValesCliente, 1000);
    }

    function mostrarTicket() {
        document.getElementById('app').classList.add('hidden');
        document.getElementById('ticket-view').style.display = 'block';
        const data = dec(s);
        document.getElementById('t-station').innerText = data.st;
        document.getElementById('t-amount').innerText = data.a + "‚Ç¨";
        document.getElementById('t-code').innerText = data.i;
        JsBarcode("#barcode", data.i, { format: "CODE128", width: 3, height: 100, displayValue: false });
    }
</script>
</body>

</html>
